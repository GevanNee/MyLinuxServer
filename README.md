
# Linux通用服务器框架

> 主要参考书籍：《C++新经典---Linux C++通信架构实战》 作者：王健伟
> 
> 其他参考：
>> linux/unix编程手册
>> 
>> nginx源码
>> 
>> 博客：<https://www.subingwen.cn/> by-苏丙温
# 目录
- [Linux通用服务器框架](#linux通用服务器框架)
  - [前言](#前言)
  - [一，进程线程结构](#一进程线程结构)
  - [二，基础设施](#二基础设施)
    - [1，日志模块](#1日志模块)
      - [效果](#效果)
      - [实现方法](#实现方法)
    - [2，配置文件（单例不加锁）](#2配置文件单例不加锁)
      - [格式：直接看配置文件本文件](#格式直接看配置文件本文件)
      - [实现](#实现)
    - [3，改进程名](#3改进程名)
      - [实现方法](#实现方法-1)
    - [4，守护进程](#4守护进程)
    - [5，信号处理](#5信号处理)
  - [三，通信模块](#三通信模块)
  - [四，业务逻辑模块(多线程)](#四业务逻辑模块多线程)
  - [五，应用层服务器安全](#五应用层服务器安全)
  - [注意](#注意)

## 前言

写这玩意几个目的：

一是复盘一下全部代码，不然写完下面忘了上面，打再多注释也会忘记。

二是看看自己有没有能力做技术分享，35岁以后失业可能就靠这个吃饭了(只有十年了)。。。

## 一，进程线程结构

- 一个master进程，n个worker进程。
- worker进程的主线程处理网络IO
- 每个worker进程有一个进程池处理业务逻辑。
- 另外三个特殊线程(附属于worker进程)：
  - 处理写事件的线程
  - 检测超时连接的线程
  - 负责延迟回收连接的线程
- **master进程的职责**：由信号或者时钟事件驱动，管理worker进程，可以做到整个服务器优雅退出(尚未实现)，或者热更新？或者子进程意外死亡再重新抬一个？目前只实现了回收子进程。

## 二，基础设施

### 1，日志模块

#### 效果

![1e86f8fd2021fdf4031e859a23a6f924.png](en-resource://database/604:1)

- 自动生成时间，日志等级和输出日志的进程编号，后面的内容是自己解析的格式化输出，类似printf这种。
- 两个函数，一个写文件，一个写屏幕(开启守护进程后失效)：
    ![12d499ee032ed9826bfb375a164a3dcc.png](en-resource://database/606:1)
- 还可以这样，格式化输出：
    ![1603c55eacae137f56b09b1a9bf4e666.png](en-resource://database/608:1)
- 如果errno不为零，后面还会跟一个括号，打印出errno对应的字符串信息，比如：
 ![9eda0b101a0972b0e0037b984d54862a.png](en-resource://database/610:1)

#### 实现方法

- 时间用 `gettimeofday()`  生成历史秒钟数，再用 `localtime_r(&second, &tm)` 转化成年月日格式
- 然后日志等级+进程编号( `getpid()` )
- 后面的内容通过百分号来判定是否进行替换。可以解析%02d, %l, %f, %P，等等，需要什么再添加。具体过程请看ngx_printf.cpp文件里的ngx_sprintf函数。

### 2，配置文件（单例不加锁）

#### 格式：直接看配置文件本文件

#### 实现

- 文件按行读取，过滤掉注释，块说明等无关内容。解析出来的key和value存起来，然后由两个接口： `getint()` 和 `getstring()` 取出。
- 按理来说单例模式应该加双检查锁保证线程安全(或许还有reorder问题)，但是同时满足以下条件就能不加锁：
  - 对该模块只读
  - 保证在进程启动后，创建多线程前将它初始化
  - 初始化失败就退出整个进程

### 3，改进程名

- 启动进程的二进制文件名字和ps命令看到的名字一般是一样的
- 但是我们可以修改这个名字
 ![ae2eeea89a66cb352198c98c88ddc651.png](en-resource://database/612:1)
 ![9f6d1dd9e230dbd64704047beaba146c.png](en-resource://database/614:1)
 可以看到ps命令出来的woker进程和master进程名字都不一样。说明被我修改过的。

- 演示：

#### 实现方法

- 略

### 4，守护进程

- 这个简单，搞清楚会话，进程组这些玩意儿就行。
- 主要是调用`setsid()` (进程组的组长无法调用这个函数)， 然后改文件权限，然后关闭STDIN STDOUT STDERR就行。具体看ngx_daemon.cpp，基本所有的守护进程方法都这样写。

### 5，信号处理

- 主要函数 `sigpromask()`，`sigempty()` 等等，自定义需要处理的信号集，目前只处理了master进程收到的，SIGCHILD信号，其他信号待添加。

## 三，通信模块

## 四，业务逻辑模块(多线程)

## 五，应用层服务器安全

## 注意

- 目前此服务器框架尚未进行大规模测试(作者提供了测试客户端，但是我不想去看MFC的内容)，但是基本的收包和发包没问题，在连接数接近进程最大描述符(目前每个进程1000，还没改)，速度也是极快。
- 由于我会QT，所以准备写一个QT客户端项目来对它进行测试(苏老师斗地主或者搞个云盘？？都行）
